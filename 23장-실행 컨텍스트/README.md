# 23장. 실행 컨텍스트

`실행 컨텍스트 (Execution Context)` 는 자바스크립트의 동작 원리를 담고 있는 핵심 개념 입니다.

`실행 컨텍스트 (Execution Context)` 를 이해함으로써 얻게되는 개념은 다음과 같습니다.

* `스코프 기반` 으로 `식별자`와 `식별자에 바인딩된 값` 을 관리하는 방법
* `호이스팅 (Hoisting)` 이 발생하는 이유
* `클로저 (Closure)` 의 동작 방식
* `태스크 큐 (Task Queue)` 와 함께 동작하는 `이벤트 헨들러` 와 `비동기 처리` 의 동작 방식



<br /><hr /><br />



# 1. 소스코드의 타입

지금부터 `소스코드` 에는 `실행 가능한 코드(Executable Code)` 라는 의미를 부여 하겠습니다.

자바스크립트는 `소스코드 (실행 가능한 코드)` 를 `4가지` 로 분류하고 있습니다.

* 전역 코드
* 함수 코드
* eval 코드
* module 코드

<br />

`소스코드 (실행 가능한 코드)` 를 `4가지` 로 분류하는 이유는 각각의 `실행 컨텍스트 (Execution Context)` 를 생성하는 과정과 관리 내용이 다르기 때문 입니다.

<br />

* 전역 코드
  * 전역 코드의 평가가 시작되면 `전역 실행 컨텍스트` 를 생성한 후, 아래의 과정들을 진행하며, 생성된  `전역 스코프` 는 `전역 실행 컨텍스트` 가 관리하게 됩니다.
  * `전역 변수` 를 관리하기 위해, 최상위 스코프인 `전역 스코프` 를 생성 합니다.
  * 전역 변수를 전역 객체의 프로퍼티에 바인딩 합니다.
  * 전역 함수를 전역 객체의 메서드로 바인딩 합니다.

* 함수 코드
  * 함수 코드의 평가가 시작되면 `함수 실행 컨텍스트` 를 생성한 후, 아래의 과정들을 진행하며, 생성된 `지역 스코프` 는 `함수 실행 컨텍스트` 가 관리하게 됩니다.
  * `지역 변수`, `매개변수`, `arguments 객체` 를 관리하기 위해, `지역 스코프` 를 생성 합니다.
  * `지역 스코프` 를 `스코프 체인` 의 일원으로 연결 합니다.

* eval 코드
  * `strick mode (엄격 모드)` 에서만 해당 합니다.
  * eval 코드의 평가가 시작되면, `eval 실행 컨텍스트` 를 생성한 후, 아래의 과정 진행하며, 생성된 `eval 자신만의 스코프` 는 `eval 실행 컨텍스트` 가 관리하게 됩니다.
  * `eval 자신만의 스코프` 를 생성 합니다.

* module 코드
  * 모듈 코드의 평가가 시작되면, `모듈 실행 컨텍스트` 를 생성한 후, 아래의 과정들을 진행하며, 생성된 `모듈 스코프` 는 `모듈 실행 컨텍스트` 가 관리하게 됩니다.
  * module 별로 `독립적인 모듈 스코프` 를 생성 합니다.

<br />

이를 `소스코드` 와 `실행 컨텍스트` 의 관계로 나타내면 다음과 같습니다.

<br />

```bash
•   전역 코드  ───> 평가 ───> `전역 실행 컨텍스트` 및 `전역 스코프` 생성
•   함수 코드  ───> 평가 ───> `함수 실행 컨텍스트` 및 `지역 스코프` 생성
•  eval 코드  ───> 평가 ───> `eval 실행 컨텍스트` 및 `eval 스코프` 생성
* module 코드 ───> 평가 ───> `모듈 실행 컨텍스트` 및 `모듈 스코프` 생성
```



<br /><hr /><br />



# 2. 소스코드의 평가와 실행

자바스크립트 엔진은 소스코드를 2개의 과정으로 나누어 처리 합니다.

* 평가 과정
* 실행 과정 (런타임))



<br /><hr /><br />



## 2-1. 평가 과정

먼저 `실행 컨텍스트` 를 만듭니다.

그리고 변수나 함수 `선언문` 만을 먼저 실행하여 변수나 함수를 생성 합니다.

생성된 변수나 함수는 `식별자` 를 `키값` 으로 사용하여 `실행 컨텍스트` 가 관리하는 `스코프` 에 등록 합니다.

<br />

아래 코드의 `평가 과정` 에서는 `var x;` 만 실행하여, 변수 `x` 를 `실행 컨텍스트` 가 관리하는 `스코프` 에 등록 합니다.

그리고 등록 대상이 `변수` 일 경우에는 `undefined` 로 초기화 하며, `함수` 일 경우에는 `Function 객체` 로 초기화 합니다.

<br />

```javascript
var x;
x = 3;
```



<br /><hr /><br />



## 2-2. 실행 과정 (런타임)

`선언문` 을 제외한 소스코드를 순차적으로 실행 시킵니다.

이는 `평가 과정` 에서 `모든 선언문` 을 `실행 컨텍스트` 가 관리하는 `스코프` 에 등록해 두었기 때문입니다.

이렇게 `실행한 결과` 는 다시 `실행 컨텍스트` 가 관리하는 `스코프` 에 재등록(값 갱신) 합니다.

<br />

아래 코드의 `실행 과정` 에서는 `x = 3;` 만 실행하고, 실행 결과는 `실행 컨텍스트` 가 관리하는 `스코프` 에 다시 등록 합니다.

<br />

이렇게 `실행 과정` 에서 변수나 함수를 참조할 때, 해당 참조값은 `실행 컨텍스트` 가 관리하는 `스코프` 에서부터 검색합니다.

만약 `현재 스코프` 에서 참조값을 찾지 못하였다면, `스코프 체인` 을 통해 `상위 스코프 전체` 에서 검색하게 됩니다.



<br /><hr /><br />



# 3. 실행 컨텍스트의 역할

`실행 컨텍스트` 는 아래의 요소로 구성되어 있습니다.

* `스코프`
  * 변수, 함수, class 등의 `식별자` 를 등록하고 관리 합니다.

* `함수 실행 순서 내부 메커니즘`
  * 코드의 실행 순서를 관리 합니다.

<br />

그리고 `스코프` 와 `함수 실행 순서 내부 메커니즘` 은 아래의 요소로 관리 합니다.

* `렉시컬 환경`
  * `스코프` 를 관리 합니다.

* `실행 컨텍스트 스택`
  * `함수 실행 순서` 를 관리하는 메커니즘 입니다.

<br />

아래의 예시 코드를 통해 `소스코드` 를 어떻게 `평가` 하고 `실행` 하는지 순차적으로 살펴보겠습니다.

```javascript
// 전역 변수 선언
const x = 10;
const y = 20;

// 함수 정의
// window.myGlobalFUnction() {} 이 등록 됩니다.
function myGlobalFunction(a) {
  // 지역 변수 선언
  const x = 300;
  const y = 400;

  // 메서드 호출
  console.log(a + x + y);
}

// 함수 호출
myGlobalFunction(1000);

// 메서드 호출
console.log(x + y);
```

<br />

위 코드를 실행하는 단계를 먼저 살펴보면 다음과 같습니다.

1. 전역 코드 평가
  * `전역 코드` 를 실행하기 위한 준비 과정 입니다.
  * 전역 스코프의 `선언부` 를 먼저 실행 합니다.
  * 선언된 `전역 변수` 와 `전역 함수` 는 `전역 스코프` 에 등록 됩니다.
    * 만약 `전역 변수` 를 `var` 로 선언하였다면, `전역 객체` 의 `프로퍼티` 로 등록 됩니다.
    * 만약 `전역 함수` 를 `함수 선언문` 으로 선언하였다면, `전역 객체` 의 `메서드` 로 등록 됩니다.

2. 전역 코드 실행
  * `전역 코드 평가` 가 끝난 후 실행되는 과정이며, `전역 코드` 의 `런타임` 시점 입니다.
  * `전역 변수` 에 값을 할당하거나, `전역 함수` 를 호출 합니다.
  * 만약 `전역 함수` 를 호출하였다면, 실행중인 전역 코드를 중지하고, 호출한 `전역 함수` 로 진입 합니다.

3. 함수 코드 평가
  * 함수 호출에 의해 함수 내부로 진입하게 되면, 시작되는 과정 입니다.
  * 함수 코드를 실행하기 위한 준비 과정 입니다.
  * `매개변수` 와 `지역변수` 선언문을 먼저 실행 합니다.
  * 함수 스코프의 `arguments 객체` 를 생성하여, `지역 스코프` 에 등록합니다.
  * `this` 바인딩도 결정됩니다.

4. 함수 코드 실행
  * `함수 코드 평가` 가 끝난 후 실행되는 과정이며, 이 시점이 `지역 스코프` 의 `런타임` 입니다.
  * `매개변수`, `지역변수`에 값을 할당합니다.
  * `myGlobalFunction()` 내부의 `console` 객체를 찾습니다.
    * `console` 객체는 `전역 객체` 의 `프로퍼티` 로 존재하며, 이를 `스코프 체인` 을 통해서 찾습니다.
    * 실제로는 `console` 은 `전역 객체의 프로퍼티` 로 등록된 상태이며, 이를 통해 알 수 있는 점은 다음과 같습니다.
      * `전역 객체 프로퍼티` 는 마치 `전역 변수` 처럼 전역 스코프를 통해서 검색이 가능해야 위 동작을 할 수 있습니다.

<br />

아래의 코드를 통해 `var` 를 사용한 `전역 변수 선언` 과 `전역 함수 선언문` 이 `전역 스코프` 뿐만 아니라, `전역 객체` 에도 등록되는 현상을 확인할 수 있습니다.

```html
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
  </head>

  <body>
    <script>
      // 전역 스코프의 전역 변수 myValue 로 등록됨
      // 추가로 
      // 전역객체의 전역 프로퍼티 myValue 로 등록됨
      var myValue = 3;
      const myConstValue = 'Const Value';

      console.group('var 를 사용한 전역 변수 선언');
      console.log('(전역 스코프) myValue: ', myValue);
      console.log('(전역 객체) window.myValue: ', window.myValue);
      console.groupEnd();

      function myFunction(groupMessage) {
        console.log(groupMessage);
      }

      myFunction('(전역 스코프) called myFunction from GlobalScope');
      window.myFunction('(전역 객체) called myFunction from globalObject');

      console.log('myConstValue: ', myConstValue);
      // 전역 객체의 프로퍼티에는 등록되지 않기 때문에
      // "window.myConstValue: undefined" 
      console.log('window.myConstValue: ', window.myConstValue);
    </script>
  </body>
</html>
```



<br /><hr /><br />



# 4. 실행 컨텍스트 스택

`3. 실행 컨텍스트의 역할` 에서 자바스크립트 엔진이 어떻게 코드를 평가하고 실행하는지 살펴보았습니다.

이번에는 `실행 컨텍스트 스택` 개념과 함께 코드의 평가와 실행 흐름을 살펴보겠습니다.

<br />

자바스크립트 엔진의 코드 평가와 실행은 다음과 같은 흐름을 가집니다.

1. 코드 평가
  * 코드에 존재하는 모든 변수 선언문과 함수 선언문 을 먼저 실행

2. 평가한 코드 실행
  * 선언문을 제외한 나머지 코드를 순차적으로 실행

<br />

`코드 평가` 를 시작하면 자바스크립트 엔진은 먼저 `실행 컨텍스트` 를 생성 합니다.

그리고 코드내에 존재하는 모든 `변수 선언문` 과 `함수 선언문` 만을 먼저 실행 합니다.

각 선언문을 실행하면 해당 변수와 함수는 `실행 컨텍스트` 에 등록됩니다.

<br />

그리고 생성했던 `실행 컨텍스트` 를 `실행 컨텍스트 스택` 에 `추가 (push)` 합니다.

이로써 평가단계를 마치고 실행단계를 실행 합니다.

`자바스크립트의 첫 실행` 시에는 `전역 코드` 를 대상으로 위 과정을 수행하고, `함수 호출` 시에는 `함수 코드` 를 대상으로 위 과정을 수행 합니다.

<br />

`실행 컨텍스트 스택` 은 `스택` 자료구조 이므로 `후입선축: LIFO (Last In First Out)` 방식으로 동작하게 됩니다.

<br />

평가단계를 마친 코드는 다음 과정으로 `실행 과정` 을 통해 나머지 코드를 실행합니다.

이 때, `함수 호출부` 가 있다면 `함수 코드 평가` 와 `함수 코드 실행` 을 하게 됩니다.

<br />

`함수 호출부` 에 의해 새로운 `함수 평가` 단계가 되면, 해당 함수에 대한 `실행 컨텍스트` 를 생성하며, `선언문` 을 `실행 컨텍스트` 에 등록 합니다.

그리고 `실행 컨텍스트 스택` 에 `등록 (push)` 합니다.

<br />

즉, 자바스크립트 엔진은 `전역 코드 실행` 과 `함수 호출` 에 대해, `실행 컨텍스트` 를 생성하고 `실행 컨텍스트 스택` 에 등록하는 방식으로 동작합니다.

만약 `함수 실행` 을 모두 마쳤다면, `실행 컨텍스트 스택` 에서 `최상위 실행 컨텍스트` 를 `제거 (pop)` 합니다.

* `스택` 자료구조 이므로, `최상위 실행 컨텍스트` 가 현재 실행중인 실행 컨텍스트가 되기 때문 입니다.

<br />

정리하면 다음과 같습니다.

* `실행 컨텍스트 스택` 은 `코드의 실행 순서` 를 관리 합니다.
* 실행 컨텍스트 스택의 `최상위 실행 컨텍스트` 는 현재 실행중인 실행 컨텍스트이며, 이를 `실행중인 실행 컨텍스트 (Running Execution Context)` 라고 합니다.



<br /><hr /><br />



# 5. 렉시컬 환경

지금까지 `실행 컨텍스트` 가 `식별자` 와 `식별자에 바인딩된 값`, `스코프` 를 관리한다고 하였습니다.

`실행 컨텍스트` 내부에는 `렉시컬 환경 (Lexical Environment)` 가 있으며, 실제로는 `렉시컬 환경 (Lexical Environment)` 의 역할 입니다.

그리고 `렉시컬 환경 (Lexical Environment)` 는 `{ 키: 값 }` 을 갖는 객체 형태의 `스코프 (전역, 함수, 블록 스코프)` 를 생성합니다.

이렇게 생성된 `스코프` 가 실제로 `식별자` 와 `식별자에 바인딩된 값` 을 관리하게 됩니다.

<br />

`렉시컬 환경 (Lexical Environment)`, 즉 `스코프` 의 구조는 다음과 같습니다.

* `환경 레코드 (Environment Record)`
* `외부 렉시컬 환경에 대한 참조 (Outer Lexical Environment Reference)`

<br />

`환경 레코드 (Environment Record)` 는 `식별자` 에 대한 관리를 하며, 다음과 같은 역할을 합니다.

* `식별자` 관리
* `식별자에 바인딩된 값` 관리

<br />

`외부 렉시컬 환경에 대한 참조 (Outer Lexical Environment Reference)` 는 다음과 같은 역할을 합니다.

* 현재 `실행 컨텍스트` 를 생성한 `상위 코드의 렉시컬 환경` 에 접근하기 위한 `참조값` 을 가집니다.
* `스코프 체인` 이 현재 스코프에서 상위 스코프 방향으로 식별자를 탐색하는 이유가 바로 `외부 렉시컬 환경 참조` 를 사용하기 때문이며, `스코프 체인` 은 현재 스코프에서 상위 스코프 방향으로 연결된 `단방향 연결 리스트` 입니다.



<br /><hr /><br />



